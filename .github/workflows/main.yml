name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Install sshpass (needed to provide SSH password)
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # Step 3: Deploy to EC2 using SSH with password
      - name: Deploy to EC2
        env:
          SSH_USER: ${{ secrets.EC2_USER }}
          SSH_HOST: ${{ secrets.EC2_HOST }}
          SSH_PASS: ${{ secrets.SSH_USER_PASS }}
        run: |
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            DEPLOY_DIR=/home/deploy/userservice

            # Ensure deployment directory exists
            mkdir -p \$DEPLOY_DIR
            cd \$DEPLOY_DIR

            # Fix Git safe directory issue
            git config --global --add safe.directory \$DEPLOY_DIR

            # Clean and update repository
            if [ -d .git ]; then
              echo 'Repository exists, pulling latest changes...'
              git reset --hard
              git clean -fd
              git pull origin main
            else
              echo 'Cloning repository for the first time...'
              git clone -b main https://github.com/integral-hub/user-service.git .
            fi

            # Run Laravel folder permission fix with password via sudo
            echo '$SSH_PASS' | sudo -S chown -R www-data:www-data storage bootstrap/cache
            echo '$SSH_PASS' | sudo -S chmod -R 775 storage bootstrap/cache
          "
